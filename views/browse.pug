extends ./layout.pug

include ./_mixins.pug

mixin browsetreeitem(uid, options, subtree, candrop, depth)
  -
    var attrs = { 'class': {} }
    var icoState = [
      options.iconoff || 'fa-folder',
      options.iconon || options.iconoff || 'fa-folder-open'
    ];
    attrs['data-url'] = options.path.join('/')
    attrs['data-uid'] = uid
    attrs['data-ico-off'] = icoState[0];
    attrs['data-ico-on'] = icoState[1];
    attrs.id = 't-' + uid
    attrs['class'].active = (uid === options.active.id)
    attrs['class']['tree-item-subtree'] = !!subtree && subtree.length > 0
    attrs['class']['view-droppable'] = candrop === true || candrop === 'files'
    attrs['class']['view-droppable-files'] = candrop === 'files'
    var canexpand = !!subtree && subtree.length > 0

  div.tree-item&attributes(attrs)
    - for (var i = 0; i < depth; i++)
      div.tree-pad
    div.tree-expand
      span&attributes({ 'class': {
        fa: canexpand,
        'fa-caret-down': canexpand && options.expand,
        'fa-caret-right': canexpand && !options.expand
      }})
    div.tree-icon
      span.fa(class=icoState[uid === options.active.id ? 1 : 0])
    div.tree-label
      = options.name
  if canexpand
    - var relpath = options.active.relpath;
    div.tree(style=!options.expand && 'display: none')
      each it in subtree
        +browsetreeitem(it.uid, {
          name: it.name,
          expand: it.name === relpath[0] && relpath.length > 1,
          path: options.path.concat([ encodeURIComponent(it.name) ]),
          active: {
            id: pathid,
            relpath: it.name === relpath[0] ? relpath.slice(1) : []
          }
        }, it.dirs, it.canwrite ? 'files' : candrop, (+depth || 0) + 1)

block contents
  - var istrash = typeof trash !== 'undefined'
  div.view-wrap
    div.nav-out
      div.nav-in
        div.nav#nav
          div.nav-padding#nav-padding
          div.nav-wrap
            ul#nav-path
              -var pp = path||[]
              +navitem(t(istrash ? 'trash.label' : 'folders'), istrash ? 'trash' : '0', true, !!folder)
              if folder
                +navitem(folder.name, folder._.uid, false, pp.length > 0)
                - var p = []
                each d,i in pp
                  - p.push(d);
                  - var r = folder.resource(p.join('/'))
                  +navitem(d, r.uid, false, i < (pp.length - 1))
                  - r.unref()
          div.nav-toolbox
            div.view-tools#nav-tools
              if req.user.is('admin')
                +action('single', 'folder||#l-0', 'folderAccessList', 'folder.access', 'user-plus', 'none')
              +action('multi', '*|w|:not(#l-trash)', 'itemDelete', 'folder.delete', 'trash-o', 'none')
              +action('multi', 'trash||#l-trash', 'trashRestore', 'trash.restore', 'reply', 'none')
              +action('multi', 'trash||#l-trash', 'trashRemove', 'trash.remove', 'remove', 'none')
    div.view-wrap-in
      div.view-wrap-in-2
        div.view
          div.view-aside#view-aside(style='width:0')
            - var cond = req.user.is('admin') ? ':not(#f-trash)' : ':not(#f-trash,#f-0,.read-only)'
            - var canadd = req.user.is('admin') || (folder && folder.canwrite(req.user))
            div.button-box(data-cond="", style=canadd?false:"display: none")
              button(type="button", disabled=!canadd, data-handler='folderAdd')
                span.fa.fa-plus
                = t("folder.new")
            div.tree-box.view-drop-target
              div.tree.tree-large
                +browsetreeitem('0', {
                  name: t('folders'),
                  expand: !!folder,
                  path: [ req.baseUrl ],
                  active: {
                    id: pathid,
                    relpath: folder ? [ folder.name ].concat(path) : []
                  }
                }, folders, false)
                +browsetreeitem('trash', {
                  name: t('trash.label'),
                  iconoff: 'fa-trash',
                  path: [ req.baseUrl, '.trash' ],
                  active: {
                    id: pathid
                  }
                }, null, true)

          div.view-resize#view-resize
            div.view-handle
          div.view-contents#view-contents(tabindex='0')
            include ./loader.pug
            include ./folder.pug

block extra
  div#acl_dialog.modal.fade(tabindex=-1, data-backdrop="static", style="display:none")
    div.modal-dialog
      div.modal-content
        div.modal-header
          button.close(type="button", data-dismiss="modal")
            span.fa.fa-close
          h4.modal-title(data-text=t('access.listof'))
            = t('access.listof')
        div.modal-body
          div.acl_loading
            span.fa.fa-spin.fa-circle-o-notch.fa-2x
            != '&nbsp;'
            = t('loading')
          div.acl_list(style="display: none")
            ul
              li.user
                button(type="button")
                  span.fa.fa-remove
                != '&nbsp;'
                span.username= ''
                != '&nbsp;'
                select
                  option(value="ro")= t('access.readonly')
                  option(value="rw")= t('access.readwrite')
              li.empty= t('access.nouser')
              li.add
                button.btn.btn-primary(type="button")
                  span.fa.fa-plus
                  != '&nbsp;'
                  = t('access.select')

          div.acl_select(style="display: none")
            div.users
        div.modal-footer
          div.acl_btnLoading
            button.btn.btn-default.cancel(type="button", data-action="cancel")
              = t('button.cancel')
          div.acl_btnList
            button.btn.btn-default.cancel(type="button", data-action="cancel")
              = t('button.cancel')
            button.btn.btn-primary.update(type="button", data-action="update")
              = t('access.save')
          div.acl_btnSelect
            button.btn.btn-default.cancel(type="button", data-action="cancel-select")
              = t('button.cancel')
            button.btn.btn-primary.select(type="button", data-action="select")
              = t('button.ok')

